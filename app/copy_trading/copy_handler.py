"""
Copy Trading Handler - FIXED VERSION
р╣Бр╕Бр╣Йр╣Др╕Вр╣Гр╕лр╣Йр╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Др╕Ыр╕Чр╕╕р╕Б Slave р╕Чр╕╡р╣Ир╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Бр╕▒р╕Ъ Master р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
Version: 3.2 - Enhanced Logging for Volume Calculation
"""

import logging
from typing import Dict, Optional, List
from datetime import datetime

logger = logging.getLogger(__name__)

class CopyHandler:
    """р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Бр╕▓р╕гр╕гр╕▒р╕Ър╣Бр╕ер╕░р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕кр╕▒р╕Нр╕Нр╕▓р╕Ур╕Ир╕▓р╕Б Master"""
    
    def __init__(self, copy_manager, symbol_mapper, copy_executor, session_manager, email_handler=None):
        self.copy_manager = copy_manager
        self.symbol_mapper = symbol_mapper
        self.copy_executor = copy_executor
        self.email_handler = email_handler

        from .balance_helper import BalanceHelper
        self.balance_helper = BalanceHelper(session_manager)

        logger.info("[COPY_HANDLER] Initialized (v3.2 - Enhanced Volume Logging)")
    
    def process_master_signal(self, api_key: str, signal_data: Dict) -> Dict:
        """
        р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕кр╕▒р╕Нр╕Нр╕▓р╕Ур╕Ир╕▓р╕Б Master EA р╣Бр╕ер╕░р╕кр╣Ир╕Зр╣Др╕Ыр╕Чр╕╕р╕Б Slave р╕Чр╕╡р╣Ир╣Гр╕Кр╣Й API key р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
        
        ЁЯФе FIXED: р╕зр╕Щр╕ер╕╣р╕Ыр╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Др╕Ыр╕Чр╕╕р╕Б Slave р╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Ир╕░р╕кр╣Ир╕Зр╣Бр╕Др╣Ир╕Хр╕▒р╕зр╣Ар╕Фр╕╡р╕вр╕з
        
        Args:
            api_key: API Key р╕Вр╕нр╕З Copy Pair
            signal_data: р╕Вр╣Йр╕нр╕бр╕╣р╕е Signal р╕Ир╕▓р╕Б Master
            
        Returns:
            Dict: {'success': bool, 'message': str, 'slaves_processed': int}
        """
        try:
            # ============================================================
            # FIXED: р╕лр╕▓р╕Чр╕╕р╕Б pairs р╕Чр╕╡р╣Ир╣Гр╕Кр╣Й API key р╕Щр╕╡р╣Йр╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Ир╕░р╕лр╕▓р╣Бр╕Др╣Ир╕Хр╕▒р╕зр╣Ар╕Фр╕╡р╕вр╕з
            # ============================================================
            matching_pairs = self._get_all_pairs_by_api_key(api_key)
            
            if not matching_pairs:
                logger.warning(f"[COPY_HANDLER] Invalid API key: {api_key[:8]}...")
                return {'success': False, 'error': 'Invalid API key'}
            
            logger.info(f"[COPY_HANDLER] Found {len(matching_pairs)} pair(s) using this API key")
            
            # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Master account р╕Ир╕▓р╕Б signal
            master_account = str(signal_data.get('account', ''))
            
            # р╕Бр╕гр╕нр╕Зр╣Ар╕Йр╕Юр╕▓р╕░ pairs р╕Чр╕╡р╣И match р╕Бр╕▒р╕Ъ master account р╣Бр╕ер╕░ status = active
            valid_pairs = []
            for pair in matching_pairs:
                # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Master account
                if master_account != pair.get('master_account'):
                    continue
                
                # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░ Pair
                if pair.get('status') != 'active':
                    logger.info(f"[COPY_HANDLER] Pair {pair.get('id')} is inactive, skipping")
                    continue
                
                # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Slave account р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕нр╕вр╕╣р╣Ир╕лр╕гр╕╖р╕нр╣Др╕бр╣И
                slave_account = pair.get('slave_account')
                if not self.balance_helper.session_manager.account_exists(slave_account):
                    logger.warning(f"[COPY_HANDLER] Slave account {slave_account} not found, skipping")
                    continue
                
                if not self.balance_helper.session_manager.is_instance_alive(slave_account):
                    logger.warning(f"[COPY_HANDLER] Slave account {slave_account} instance not alive, skipping")
                    continue
                
                valid_pairs.append(pair)
            
            if not valid_pairs:
                logger.warning(
                    f"[COPY_HANDLER] No valid pairs found for master {master_account}"
                )
                return {'success': False, 'error': 'No valid slave accounts available'}
            
            logger.info(f"[COPY_HANDLER] Processing signal for {len(valid_pairs)} slave(s)")
            
            # ============================================================
            # FIXED: р╕зр╕Щр╕ер╕╣р╕Ыр╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Др╕Ыр╕Чр╕╕р╕Б Slave
            # ============================================================
            success_count = 0
            failed_count = 0
            skipped_count = 0
            results = []
            
            for pair in valid_pairs:
                slave_account = pair.get('slave_account')
                
                try:
                    # р╣Бр╕Ыр╕ер╕З Signal р╣Ар╕Ыр╣Зр╕Щ Command р╕кр╕│р╕лр╕гр╕▒р╕Ъ Slave р╕Щр╕╡р╣Й
                    slave_command = self._convert_signal_to_command(signal_data, pair)
                    if not slave_command:
                        # тнР р╕Цр╣Йр╕▓ None р╣Бр╕кр╕Фр╕Зр╕зр╣Ир╕▓ skip р╣Вр╕Фр╕вр╕Хр╕▒р╣Йр╕Зр╣Гр╕И (р╣Ар╕Кр╣Ир╕Щ copy_psl = False р╣Гр╕Щ MODIFY event)
                        logger.info(f"[COPY_HANDLER] тЪая╕П Skipped slave {slave_account} (command not applicable)")
                        skipped_count += 1
                        continue
                    
                    # р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Др╕Ыр╕вр╕▒р╕З Slave р╕Щр╕╡р╣Й
                    logger.info(f"[COPY_HANDLER] Executing command on slave: {slave_account}")
                    result = self.copy_executor.execute_on_slave(
                        slave_account=slave_account,
                        command=slave_command,
                        pair=pair
                    )
                    
                    if result.get('success'):
                        success_count += 1
                        logger.info(f"[COPY_HANDLER] тЬЕ Successfully sent to slave {slave_account}")
                    else:
                        failed_count += 1
                        logger.error(f"[COPY_HANDLER] тЭМ Failed to send to slave {slave_account}: {result.get('error')}")
                    
                    results.append({
                        'slave_account': slave_account,
                        'success': result.get('success'),
                        'error': result.get('error')
                    })
                
                except Exception as e:
                    logger.error(f"[COPY_HANDLER] Error processing slave {slave_account}: {e}", exc_info=True)
                    failed_count += 1
                    results.append({
                        'slave_account': slave_account,
                        'success': False,
                        'error': str(e)
                    })
            
            # р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
            total_slaves = len(valid_pairs)
            logger.info(
                f"[COPY_HANDLER] тЬЕ Signal processed: "
                f"{success_count}/{total_slaves} successful, "
                f"{failed_count}/{total_slaves} failed, "
                f"{skipped_count}/{total_slaves} skipped"
            )
            
            return {
                'success': success_count > 0,
                'slaves_processed': success_count,
                'slaves_failed': failed_count,
                'slaves_skipped': skipped_count,
                'total_slaves': total_slaves,
                'results': results,
                'message': f'Sent to {success_count}/{total_slaves} slaves ({skipped_count} skipped)'
            }
        
        except Exception as e:
            logger.error(f"[COPY_HANDLER] Error processing signal: {e}", exc_info=True)
            return {'success': False, 'error': str(e)}
    
    # ============================================================
    # FIXED: р╣Ар╕Юр╕┤р╣Ир╕бр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕▓р╕Чр╕╕р╕Б pairs р╕Чр╕╡р╣Ир╣Гр╕Кр╣Й API key р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
    # ============================================================
    def _get_all_pairs_by_api_key(self, api_key: str) -> List[Dict]:
        """
        р╕лр╕▓р╕Чр╕╕р╕Б pairs р╕Чр╕╡р╣Ир╣Гр╕Кр╣Й API key р╕Щр╕╡р╣Й
        
        Args:
            api_key: API Key р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕лр╕▓
            
        Returns:
            List[Dict]: р╕гр╕▓р╕вр╕Бр╕▓р╕г pairs р╕Чр╕╡р╣Ир╣Гр╕Кр╣Й API key р╕Щр╕╡р╣Й
        """
        matching_pairs = []
        
        try:
            # р╕Др╣Йр╕Щр╕лр╕▓р╕Чр╕╕р╕Б pairs р╕Ир╕▓р╕Б CopyManager
            all_pairs = self.copy_manager.get_all_pairs()
            
            # р╕Бр╕гр╕нр╕Зр╣Ар╕Йр╕Юр╕▓р╕░ pairs р╕Чр╕╡р╣Ир╣Гр╕Кр╣Й API key р╕Щр╕╡р╣Й
            for pair in all_pairs:
                if pair.get('api_token') == api_key or pair.get('apiToken') == api_key:
                    matching_pairs.append(pair)
                    logger.debug(f"[COPY_HANDLER] Found pair {pair.get('id')} with matching API key")
            
            if matching_pairs:
                logger.info(f"[COPY_HANDLER] Found {len(matching_pairs)} pair(s) with API key {api_key[:8]}...")
            else:
                logger.warning(f"[COPY_HANDLER] No pairs found with API key {api_key[:8]}...")
                
        except Exception as e:
            logger.error(f"[COPY_HANDLER] Error finding pairs by API key: {e}", exc_info=True)
        
        return matching_pairs
    
    def _convert_signal_to_command(self, signal_data: Dict, pair: Dict) -> Optional[Dict]:
        """
        р╣Бр╕Ыр╕ер╕З Signal р╕Ир╕▓р╕Б Master р╣Ар╕Ыр╣Зр╕Щ Command р╕кр╕│р╕лр╕гр╕▒р╕Ъ Slave
        
        ЁЯФе ENHANCED: р╣Ар╕Юр╕┤р╣Ир╕б Logging р╕Чр╕╡р╣Ир╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Вр╕╢р╣Йр╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У Volume
        
        Args:
            signal_data: р╕Вр╣Йр╕нр╕бр╕╣р╕е Signal р╕Ир╕▓р╕Б Master
            pair: р╕Вр╣Йр╕нр╕бр╕╣р╕е Copy Pair
            
        Returns:
            Dict р╕лр╕гр╕╖р╕н None: Command р╕кр╕│р╕лр╕гр╕▒р╕Ъ Slave р╕лр╕гр╕╖р╕н None р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Др╕зр╕г copy
        """
        try:
            # Extract data
            master_account = str(signal_data.get('account', ''))
            slave_account = pair.get('slave_account')
            event = signal_data.get('event', '').lower()
            master_symbol = signal_data.get('symbol', '')
            trade_type = str(signal_data.get('type', 'BUY')).upper()
            order_id = signal_data.get('order_id')
            
            settings = pair.get('settings', {})
            auto_map_volume = settings.get('auto_map_volume', True)
            copy_psl = settings.get('copy_psl', True)
            
            # ЁЯФе ENHANCED: Log р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Чр╕╡р╣Ир╕кр╕│р╕Др╕▒р╕Н
            logger.info(
                f"[COPY_HANDLER] ЁЯФз Settings for Pair {pair.get('id')}:\n"
                f"  auto_map_volume: {auto_map_volume}\n"
                f"  volume_mode: {settings.get('volume_mode', 'multiply')}\n"
                f"  multiplier: {settings.get('multiplier', 1.0)}\n"
                f"  copy_psl: {copy_psl}"
            )
            
            # 1. Auto Mapping Symbol
            slave_symbol = master_symbol
            if settings.get('auto_map_symbol', True):
                mapped = self.symbol_mapper.map_symbol(
                    master_symbol,
                    from_account=master_account,
                    to_account=slave_account
                )
                if mapped and mapped != master_symbol:
                    slave_symbol = mapped
                    logger.info(f"[COPY_HANDLER] Symbol mapped: {master_symbol} тЖТ {slave_symbol}")
            
            # 2. Calculate Volume
            volume = float(signal_data.get('volume', 0.01))
            original_volume = volume
            
            # ЁЯФе ENHANCED: Log р╕Бр╣Ир╕нр╕Щр╕Др╕│р╕Щр╕зр╕У Volume
            logger.info(
                f"[COPY_HANDLER] ЁЯУК Volume Calculation Started:\n"
                f"  Master Volume: {volume}\n"
                f"  Master Symbol: {master_symbol}\n"
                f"  Slave Symbol: {slave_symbol}\n"
                f"  Master Account: {master_account}\n"
                f"  Slave Account: {slave_account}"
            )
            
            # р╕Др╕│р╕Щр╕зр╕У Volume
            volume = self._calculate_slave_volume(
                master_volume=volume,
                settings=settings,
                slave_account=slave_account,
                symbol=slave_symbol,
                master_account=master_account,
                master_symbol=master_symbol
            )
            
            # ЁЯФе ENHANCED: Log р╕лр╕ер╕▒р╕Зр╕Др╕│р╕Щр╕зр╕У Volume
            if original_volume > 0:
                adjustment_pct = ((volume/original_volume - 1) * 100)
            else:
                adjustment_pct = 0
                
            logger.info(
                f"[COPY_HANDLER] ЁЯУК Volume Calculation Result:\n"
                f"  Original Volume: {original_volume}\n"
                f"  Calculated Volume: {volume}\n"
                f"  Adjustment: {adjustment_pct:+.2f}%"
            )
            
            # 3. Generate Comment
            copy_comment = f"COPY_{order_id}" if order_id else f"Copy from Master {master_account}"
            logger.info(f"[COPY_HANDLER] Generated comment: {copy_comment}")
            
            # 4. Create Command based on Event Type
            
            # EVENT: OPEN ORDER
            if event in ['deal_add', 'order_add']:
                logger.info(f"[COPY_HANDLER] Processing OPEN ORDER event")
                
                command = {
                    'action': trade_type,
                    'symbol': slave_symbol,
                    'volume': volume,  # тЬЕ Volume р╕Чр╕╡р╣Ир╕Др╕│р╕Щр╕зр╕Ур╣Бр╕ер╣Йр╕з
                    'order_type': 'market',
                    'comment': copy_comment
                }
                
                if copy_psl:
                    if signal_data.get('tp') is not None:
                        command['take_profit'] = float(signal_data['tp'])
                    if signal_data.get('sl') is not None:
                        command['stop_loss'] = float(signal_data['sl'])
                    logger.info(f"[COPY_HANDLER] Copy TP/SL is ENABLED")
                
                logger.info(
                    f"[COPY_HANDLER] тЬЕ OPEN Command created: "
                    f"{trade_type} {slave_symbol} {volume} lots | Comment: {copy_comment}"
                )
                return command
            
            # EVENT: CLOSE ORDER
            elif event in ['deal_close', 'position_close']:
                logger.info(f"[COPY_HANDLER] Processing CLOSE ORDER event")
                
                if order_id:
                    # тнР р╣Гр╕Кр╣Й action: "close" р╣Бр╕Чр╕Щ "close_by_comment" р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й EA р╕гр╕╣р╣Йр╕Ир╕▒р╕Б
                    command = {
                        'action': 'close',
                        'comment': copy_comment,
                        'symbol': slave_symbol
                    }
                    logger.info(f"[COPY_HANDLER] тЬЕ CLOSE Command created (by Comment): {copy_comment}")
                    return command
                else:
                    command = {
                        'action': 'close_symbol',
                        'symbol': slave_symbol
                    }
                    logger.info(f"[COPY_HANDLER] тЬЕ CLOSE Command created (by Symbol): {slave_symbol}")
                    return command
            
            # EVENT: MODIFY ORDER
            elif event in ['position_modify', 'order_modify']:
                logger.info(f"[COPY_HANDLER] Processing MODIFY ORDER event")
                
                # тнР р╣Ар╕Кр╣Зр╕Д copy_psl р╕Бр╣Ир╕нр╕Щр╕зр╣Ир╕▓р╕Ир╕░р╕Др╕▒р╕Фр╕ер╕нр╕Б TP/SL р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
                if not copy_psl:
                    logger.info(f"[COPY_HANDLER] тЪая╕П Copy TP/SL is DISABLED, skipping MODIFY event")
                    return None
                
                new_tp = signal_data.get('tp')
                new_sl = signal_data.get('sl')
                
                if order_id:
                    command = {
                        'action': 'modify',
                        'comment': copy_comment,
                        'symbol': slave_symbol
                    }
                    if new_tp is not None:
                        command['take_profit'] = float(new_tp)
                    if new_sl is not None:
                        command['stop_loss'] = float(new_sl)
                    
                    logger.info(
                        f"[COPY_HANDLER] тЬЕ MODIFY Command created (by Comment): "
                        f"Comment: {copy_comment} | TP: {new_tp} | SL: {new_sl}"
                    )
                    return command
            
            logger.warning(f"[COPY_HANDLER] Unknown event type: {event}")
            return None
            
        except Exception as e:
            logger.error(f"[COPY_HANDLER] Error converting signal: {e}", exc_info=True)
            return None
    
    def _calculate_slave_volume(
        self,
        master_volume: float,
        settings: Dict,
        slave_account: str,
        symbol: str,
        master_account: str = None,
        master_symbol: str = None
    ) -> float:
        """
        р╕Др╕│р╕Щр╕зр╕У Volume р╕кр╕│р╕лр╕гр╕▒р╕Ъ Slave р╕Хр╕▓р╕б settings
        
        ЁЯФе ENHANCED: р╣Ар╕Юр╕┤р╣Ир╕б Logging р╕Чр╕╡р╣Ир╕Кр╕▒р╕Фр╣Ар╕Ир╕Щр╕Вр╕╢р╣Йр╕Щр╣Гр╕Щр╕Чр╕╕р╕Бр╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щ
        
        Modes:
        - fixed: р╣Гр╕Кр╣Йр╕Др╣Ир╕▓ multiplier р╣Ар╕Ыр╣Зр╕Щ volume р╕Др╕Зр╕Чр╕╡р╣И
        - percent: р╕Др╕│р╕Щр╕зр╕Ур╕Ир╕▓р╕Б balance ratio ├Ч multiplier
        - multiply: master_volume ├Ч multiplier (р╕гр╕нр╕Зр╕гр╕▒р╕Ъ Tick Value Auto-Detection)
        
        Tick Value Auto-Detection:
        - р╕Чр╕│р╕Зр╕▓р╕Щр╣Ар╕Йр╕Юр╕▓р╕░р╣Гр╕Щ multiply mode + auto_map_volume = True
        - р╕Ыр╕гр╕▒р╕Ъ volume р╣Гр╕лр╣Йр╕бр╕╣р╕ер╕Др╣Ир╕▓р╣Ар╕Чр╣Ир╕▓р╕Бр╕▒р╕Щр╣Ар╕бр╕╖р╣Ир╕н tick value р╕Хр╣Ир╕▓р╕Зр╕Бр╕▒р╕Щ
        """
        try:
            volume_mode = settings.get('volume_mode', 'multiply').lower()
            multiplier = float(settings.get('multiplier', 1.0))
            auto_map_volume = settings.get('auto_map_volume', True)
            
            logger.info(
                f"[COPY_HANDLER] ЁЯФз Volume Calculation Mode:\n"
                f"  Mode: {volume_mode}\n"
                f"  Multiplier: {multiplier}\n"
                f"  Auto Map Volume: {auto_map_volume}\n"
                f"  Master Volume: {master_volume}"
            )
            
            # ============================================================
            # MODE 1: FIXED VOLUME
            # ============================================================
            if volume_mode == 'fixed':
                volume = multiplier
                logger.info(f"[COPY_HANDLER] тЬЕ FIXED mode: Volume = {volume}")
                return volume
            
            # ============================================================
            # MODE 2: PERCENT (Balance-Based)
            # ============================================================
            elif volume_mode == 'percent':
                if not master_account or not slave_account:
                    logger.warning("[COPY_HANDLER] тЪая╕П Missing account info for percent mode, using multiply fallback")
                    return master_volume * multiplier
                
                master_balance = self.balance_helper.get_account_balance(master_account)
                slave_balance = self.balance_helper.get_account_balance(slave_account)
                
                if master_balance and slave_balance and master_balance > 0:
                    ratio = slave_balance / master_balance
                    volume = master_volume * ratio * multiplier
                    logger.info(
                        f"[COPY_HANDLER] тЬЕ PERCENT mode:\n"
                        f"  Master Balance: ${master_balance:.2f}\n"
                        f"  Slave Balance: ${slave_balance:.2f}\n"
                        f"  Balance Ratio: {ratio:.4f}\n"
                        f"  Calculation: {master_volume} ├Ч {ratio:.4f} ├Ч {multiplier} = {volume:.4f}"
                    )
                    return volume
                else:
                    logger.warning("[COPY_HANDLER] тЪая╕П Cannot get balances, using multiply fallback")
                    return master_volume * multiplier
            
            # ============================================================
            # MODE 3: MULTIPLY (with Tick Value Auto-Detection)
            # ============================================================
            else:
                logger.info(f"[COPY_HANDLER] ЁЯУК MULTIPLY mode activated")
                
                # ЁЯФе Tick Value Auto-Detection
                # р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕В: auto_map_volume = True + master_symbol тЙа slave_symbol
                if auto_map_volume and master_symbol and master_symbol != symbol:
                    logger.info(
                        f"[COPY_HANDLER] ЁЯФе Tick Value Auto-Detection:\n"
                        f"  Checking symbols: {master_symbol} vs {symbol}"
                    )
                    
                    master_info = self.balance_helper.session_manager.get_symbol_info(
                        master_account, master_symbol
                    )
                    slave_info = self.balance_helper.session_manager.get_symbol_info(
                        slave_account, symbol
                    )
                    
                    if (master_info and slave_info and 
                        master_info.get('trade_contract_size') and 
                        slave_info.get('trade_contract_size')):
                        
                        master_tick = float(master_info['trade_contract_size'])
                        slave_tick = float(slave_info['trade_contract_size'])
                        
                        logger.info(
                            f"[COPY_HANDLER] ЁЯУК Tick Value Info:\n"
                            f"  Master ({master_symbol}): {master_tick}\n"
                            f"  Slave ({symbol}): {slave_tick}"
                        )
                        
                        if master_tick != slave_tick and master_tick > 0 and slave_tick > 0:
                            # тЬЕ Tick Value р╕Хр╣Ир╕▓р╕Зр╕Бр╕▒р╕Щ тЖТ р╕Ыр╕гр╕▒р╕Ъ Volume
                            tick_ratio = master_tick / slave_tick
                            volume = master_volume * tick_ratio * multiplier
                            
                            logger.info(
                                f"[COPY_HANDLER] тЬЕ TICK VALUE ADJUSTED:\n"
                                f"  Tick Ratio: {tick_ratio:.4f}\n"
                                f"  Calculation: {master_volume} ├Ч {tick_ratio:.4f} ├Ч {multiplier} = {volume:.4f}\n"
                                f"  Trade Value (Master): ${master_volume * master_tick:.2f}\n"
                                f"  Trade Value (Slave): ${volume * slave_tick:.2f}"
                            )
                            return volume
                        else:
                            logger.info(
                                f"[COPY_HANDLER] тД╣я╕П Tick Values are equal or invalid, "
                                f"using standard multiply"
                            )
                    else:
                        logger.warning(
                            f"[COPY_HANDLER] тЪая╕П Cannot get symbol info for tick value detection:\n"
                            f"  Master info: {bool(master_info)}\n"
                            f"  Slave info: {bool(slave_info)}"
                        )
                elif not auto_map_volume:
                    logger.info(f"[COPY_HANDLER] тД╣я╕П Auto Map Volume is OFF, using standard multiply")
                elif master_symbol == symbol:
                    logger.info(f"[COPY_HANDLER] тД╣я╕П Same symbols ({symbol}), using standard multiply")
                
                # Standard Multiply (fallback)
                volume = master_volume * multiplier
                logger.info(
                    f"[COPY_HANDLER] тЬЕ Standard MULTIPLY:\n"
                    f"  Calculation: {master_volume} ├Ч {multiplier} = {volume}"
                )
                return volume
                
        except Exception as e:
            logger.error(f"[COPY_HANDLER] тЭМ Error calculating volume: {e}", exc_info=True)
            logger.info(f"[COPY_HANDLER] Using fallback: master_volume = {master_volume}")
            return master_volume
